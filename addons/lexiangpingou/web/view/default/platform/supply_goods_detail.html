{php include wl_template('common/header');}
<link rel="stylesheet" href="{TG_URL_WRES}lib/bootstrap-chinese-region/bootstrap-chinese-region.css">
<style>
.detail .form-group {
    width: 49%;
    display: inline-block;
}

.detail img.payimg {
    max-width: 100%;
}

.detail label {
    text-align: right;
}

.gdesc,
.goodsdesc {
    word-wrap: break-word;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    max-height: 400px;
    overflow-y: auto;
}

.detail .nav-tabs>li>a.active {
    border-bottom-color: #44b549;
    background-color: #eee;
}
.options{
        padding-left: 0;
    }
    .options li{
        display: flex;
        align-items: center;
        display: -webkit-flex;
        -webkit-align-items: center;
    }
    .options li div{
        margin-left: 30px;
    }
    .options a,.courier a{
        display: inline-block;
        padding: 3px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 0 5px;
        color: inherit;
    }
    .options a.active,.courier a.active{
        background-color: #428bca;
        border-color: #428bca;
        color: #fff;
    }
    .modal-backdrop.in{display: none!important;}
    .model-dialog {
        z-index: 10;
        position: fixed;
        top: 0;
        left: 0;
        height: 80%;
        overflow: auto;
        margin-bottom: 10%;
    }
    .model-dialog .hiden-map {
        background: #fff;
    }
    .model-dialog .hiden-map {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        height: 100%;
        background: rgba(0,0,0,.5);
        width: 100%;
    }
    .model-dialog .delivery-body {
        width: 55%;
        margin: auto;
        z-index: 2;
        position: relative;
    }
    .on {
        white-space: initial !important;
    }
    .li-td {
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .datetimepicker {
        position: relative;
        top: -24px;
        right: -70px;
        width: 70px;
        height: 30px;
        opacity: 0 !important;
    }
</style>
<div class="main">
    <div class="page-trade-order detail" >
        <div style="background: #ffffff;padding-bottom: 50px;">
            <div class="panel-heading">商品详情
                
            </div>
            <div class="panel-body">
                <ul class="nav nav-tabs" id="nav">
                    <li><a data-class=".jbxx" class="active" href="javascript:;">基本信息</a></li>
                    <li><a data-class=".kcgg" href="javascript:;">规格库存</a></li>
                    <li><a data-class=".jjxq" href="javascript:;">商品简介</a></li>
                    <li><a data-class=".spxq" href="javascript:;">商品详情</a></li>
                </ul>
                <div class="jbxx">
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">商品名称</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control gname" readonly value="{$goods['name']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">单位</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control unit" readonly value="{$goods['unit']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">库存</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control stock" readonly value="{$goods['stock']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">服务费</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control taxrate" readonly value="{$goods['taxrate']}%"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">售价</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control oprice" readonly value="{$goods['oprice']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">供应价</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control mprice" readonly value="{$goods['mprice']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">重量</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control weight" readonly value="{$goods['weight']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">规格</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control hasoption" readonly value="{if $goods['hasoption'] == 1 }有{else}无{/if}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">价格类型</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control ctype" readonly value="{if $goods['ctype'] == 1 }整件批发{else}一件代发{/if}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">首页视频</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control index_video" readonly/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">快递</label>
                        <div class="col-md-7 dispatch_list">
                            {loop $goods['dispatch_list'] $item}
                            <a style="margin-right: 5px" href="javascript:;" class="btn btn-default btn-sm" onclick="showDelivery({$item['id']})">{$item['name']}</a>
                            {/loop}
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">首页图片</label>
                        <div class="col-md-7">
                            <img class="gimg payimg" src="{$goods['share_image']}" alt="">
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <!--<div class="form-group">-->
                    <!--<label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">图集</label>-->
                    <!--<div class="col-md-7 imgs">-->
                    <!--&lt;!&ndash;<img style="position: absolute;bottom:0;right: 100%;display: none;z-index: 20" class="id_card_img" src="" alt="">&ndash;&gt;-->
                    <!--</div>-->
                    <!--<div style="clear: both;"></div>-->
                    <!--</div>-->
                </div>
                <div class="kcgg" style="display: none">
                        {$goods['guige']}
                </div>
                <div class="jjxq" style="display: none">
                    <div class="form-group" style="width: 100%">
                        <label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">商品属性</label>
                        <div class="col-md-9 params">
                        </div>
                        <div style="clear: both;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">分享标题</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control share_title" readonly value="{$goods['share_title']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">分享描述</label>
                        <div class="col-md-7">
                            <input type="text" class="form-control share_desc" readonly value="{$goods['share_desc']}"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-6 col-md-4 col-lg-4 control-label">分享图片</label>
                        <div class="col-md-7">
                            <img class="share_image payimg" src="{$goods['share_image']}" alt="">
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <div class="spxq" style="display: none">
                    <div class="form-group" style="width: 100%">
                        <label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">详情简介</label>
                        <div class="col-md-9 goodsdesc" style="margin-left: 10px">
                                                                
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group" style="width: 100%;max-height: 500px;">
                        <label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">商品详情</label>
                        <div class="col-md-9 gdesc" style="margin-left: 10px">
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <td class="text-center" style="position:relative;">
                        
                        {if $goods['status'] == 1 && $goods['supply_id'] != $_W['uniacid'] && $goods['activetime'] > TIMESTAMP}
                            {if intval($goods['is_copy']) == 0 && intval($goods['ctype']) == 0}
                                <a href="javascript:;" style="display: block;float:right;padding: 5px;width: 80px;border-radius: 5px;border: 1px solid" onclick="copy(this,event,{$goods['id']},0)">采纳商品</a>
                            {/if}
                            {if intval($goods['copy']) == 0 && intval($goods['ctype']) == 1}
                                <a href="javascript:;" style="display: block;float:right;padding: 5px;width: 80px;border-radius: 5px; border: 1px solid" onclick="openmode(this,{$goods['id']},{$goods['hasoption']},{$goods['mprice']},{$goods['weight']},{$goods['min_num']})">批量购买</a>
                            {/if}
    
                        {/if}
    
                        
                    </td>
            </div>
        </div>
    </div>

</div>
<div class="paydetail" style="position: fixed;z-index:10;top: 0;left: 0;background-color: rgba(0,0,0,0.7); width: 100%;height: 100%;display: none">
        <div class="panel panel-default" style="position: absolute;top: 15%;left: 25%;width: 50%">
            <div class="panel-heading">批量购买
                <a onclick="$('.paydetail').fadeOut();clearTimeJS();" style="cursor:pointer; float:right; margin-right:10px; font-weight:bold;" href="javascript:;">X</a>
            </div>
            <div class="panel-body" onclick="$('.dropdown-menu').hide()">
                <div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">姓名</label>
                        <div class="col-md-8">
                            <input class="form-control name" value=""/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">手机号</label>
                        <div class="col-md-8">
                            <input class="form-control tel" maxlength="11" value=""/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group hasoption" style="display: none">
                        <div style="display:table;content:' ';"></div>
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">规格</label>
                        <div class="col-md-8">
                            <ul class="options">
                                <li>
                                    <!--<h5>尺寸</h5>-->
                                    <!--<div>-->
                                    <!--<a href="javascript:;">大号</a>-->
                                    <!--<a href="javascript:;">中号</a>-->
                                    <!--</div>-->
                                </li>
                            </ul>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">重量</label>
                        <div class="col-md-8">
                            <input class="form-control weight" value="" readonly/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">单价</label>
                        <div class="col-md-8">
                            <input class="form-control oprice" value="" readonly/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">数量</label>
                        <div class="col-md-8">
                            <input type="number" class="form-control num" value="1"/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <div style="display:table;content:' ';"></div>
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">地址</label>
                        <div class="col-md-8">
                            <div class="form-group">
                                <div onclick="event.stopPropagation();$('.dropdown-menu').toggle();" class="bs-chinese-region flat dropdown" data-submit-type="id" data-min-level="1" data-max-level="3">
                                    <!--<input type="text" class="form-control" id="address" placeholder="选择你的地区" data-toggle="dropdown" readonly="" value="">-->
                                    <!--<div class="dropdown-menu" role="menu" aria-labelledby="dLabel">-->
                                        <!--<div>-->
                                            <!--<ul class="nav nav-tabs" role="tablist">-->
                                                <!--<li role="presentation" class="active"><a href="#province" data-next="city" role="tab" data-toggle="tab">省份</a></li>-->
                                                <!--<li role="presentation"><a href="#city" data-next="district" role="tab" data-toggle="tab">城市</a></li>-->
                                                <!--<li role="presentation"><a href="#district" data-next="street" role="tab" data-toggle="tab">县区</a></li>-->
                                            <!--</ul>-->
                                            <!--<div class="tab-content">-->
                                                <!--<div role="tabpanel" class="tab-pane active" id="province">&#45;&#45;</div>-->
                                                <!--<div role="tabpanel" class="tab-pane" id="city">&#45;&#45;</div>-->
                                                <!--<div role="tabpanel" class="tab-pane" id="district">&#45;&#45;</div>-->
                                            <!--</div>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <select onchange="ajaxCity()" name="province" class="categoryI form-control tpl-category-parent" style="width:30%;margin-right:3%;display: inline-block;">
                                        <option value="">省</option>
                                        {loop $province $item}
                                        <option value="{$item['id']}">{$item['areaname']}</option>
                                        {/loop}
                                    </select>
                                    <select onchange="ajaxCounty()" name="city" class="categoryI form-control tpl-category-parent" style="width:30%;margin-right:3%;display: inline-block;">
                                        <option value="">市</option>
                                    </select>
                                    <select name="county" class="categoryI form-control tpl-category-parent" style="width:30%;display: inline-block;">
                                        <option value="">区</option>
                                    </select>
                                </div>
                                <input style="margin-top: 15px;" type="text" class="form-control addDetail"  placeholder="请填写详细地址" value="">
                            </div>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group kd">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">快递</label>
                        <div class="col-md-8 courier">
                            <!--<a href="javascript:;">顺丰</a>-->
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-1 col-lg-1 control-label">运费</label>
                        <div class="col-md-8">
                            <input type="number" class="form-control courier_num" value="" readonly/>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                </div>
            </div>
            <div class="panel-footer" style="height: 60px">
                <input onclick="buy(this)" type="submit" value="立即购买" class="btn btn-primary col-lg-2 buy" style="float: right;">
            </div>
            <div class="wx" style="text-align: center;position: absolute;right: 5%;width: 20%;top:20%;display: none;z-index: 100">
                <img id="payimage" src="" alt="" style="width: 200px;">
                <p style="text-align: center" id="myDiv"></p>
            </div>
        </div>
    </div>

    
<script>
    var urlC = 'http://paysdk.weixin.qq.com/example/qrcode.php?data=';    
    function escapeHtml(text) {
        var a=text.replace(/(\&lt;)/g,"<");
        var b=a.replace(/(\&gt;)/g,">");
        var c=b.replace(/(\&amp;)/g,"\&");
        var d=c.replace(/(\&quot;)/g,"\"");
        return d;
    }
    console.log({php echo json_encode($goods)})
    $('#nav li').eq(2).click(function(){
        $('.jjxq').css("display","block")
        $('.kcgg').css("display","none")
        $('.spxq').css("display","none")
        $('.jbxx').css("display","none")
        $('#nav li a').eq(2).addClass('active').parent('li').siblings('li').children('a').removeClass('active')
    })
    $('#nav li').eq(0).click(function(){
        $('.jjxq').css("display","none")
        $('.kcgg').css("display","none")
        $('.spxq').css("display","none")
        $('.jbxx').css("display","block")
        $('#nav li a').eq(0).addClass('active').parent('li').siblings('li').children('a').removeClass('active')
    })
    $('#nav li').eq(1).click(function(){
        $('.jjxq').css("display","none")
        $('.kcgg').css("display","block")
        $('.spxq').css("display","none")
        $('.jbxx').css("display","none")
        $('#nav li a').eq(1).addClass('active').parent('li').siblings('li').children('a').removeClass('active')
    })
    $('#nav li').eq(3).click(function(){
        $('.jjxq').css("display","none")
        $('.kcgg').css("display","none")
        $('.spxq').css("display","block")
        $('.jbxx').css("display","none")
        $('#nav li a').eq(3).addClass('active').parent('li').siblings('li').children('a').removeClass('active')
    })
    var goodsdesc="{$goods['goodsdesc']}"
    var gdesc="{$goods['gdesc']}"    
    $('.goodsdesc').html(escapeHtml(goodsdesc));
    $('.gdesc').html(escapeHtml(gdesc))
    //if("{$goods['hasoption']}"==1){
        console.log()
        if("{$goods['hasoption']}"==0){
            $('#nav li').eq(1).css("display","none")
        }else{
            $('#nav li').eq(1).css("display","block")            
        }
     


function copy(self,e,ida,s,option){
        var id = $(self).prev().prev().attr("data-id");
        if(option==1){

        }else {
            e.stopPropagation();

            var html = "采纳本商品，将保存在【极限单品商品管理】【下架的商品】中！";
            util.nailConfirm(self, function (state) {
                if (!state) return;
                $.post("{php echo web_url('platform/platform_copy')}", {id: ida, copy: s}, function (data) {
                    console.log(data);
                    if (Number(data.status) > 0) {
                        util.tips("采纳成功");
                        setTimeout(function () {
                            location.href = "{php echo web_url('goods/jxdp' , array('status' => 2));}";
                        }, 1000)
                    } else {
                        util.tips("采纳失败");
                    }
                }, 'json');
            }, {html: html});
        }
    }



     //点击批量购买弹出选择框
    function openmode(self,id,option,oprice,weight,min_num) {
        //重置参数
        $('input.name,input.tel,input.weight,input.oprice,#address,.addDetail,input.courier_num').val('');
        $('input.num').val(1);


        $('.buy').attr('data-id',id).attr('data-option',option).attr('data-minnum',min_num);
        $('.oprice').val(oprice);
        //加载规格
        if(option==1){
            $.get(
                "{php echo web_url('platform/goods_list/options')}",
                {'id':id},
                function(res){
//                    console.log(res);
                    var data=JSON.parse(res);
                    $('.buy').attr('data-options',JSON.stringify(data.options));
                    var html='';
                    for(var i=0;i<data.allspecs.length;i++){
                        var li='<li><h5>'+data.allspecs[i].title+'</h5><div>';
                        var a='';
                        for(var j=0;j<data.allspecs[i].items.length;j++){
                            a+='<a href="javascript:;">'+data.allspecs[i].items[j].title+'</a>'
                        }
                        html+=li+a+'</div></li>';
                    }
                    $('ul.options').html(html);
                }
            );
            $('.hasoption').css('display','block');
        }else{
            $('.hasoption').css('display','none');
            $('.weight').val(weight);
        }
        //加载运费模板
        $.get(
            "{php echo web_url('platform/goods_list/yunfei')}",
            {"id":id},
            function(res){
                var data=JSON.parse(res);
                if(data.dispatch_list){
                    var html='';
                    for(var j=0;j<data.dispatch_list.length;j++){
                        html += '<a onclick="courier(this)" data-id="'+data.dispatch_list[j].id+'" href="javascript:;">'+data.dispatch_list[j].name+'</a>';
                    }
                    $('.courier').html(html);
                }else{
                    $('.courier').html('<a href="javascript:;" class="active">包邮</a>');
                    $('.courier_num').val('0.00');
                }
                $('.paydetail').fadeIn();
            }
        );
    }

    //规格选择
    $('.options').on('click','a',function(){
        if($(this).html()=='包邮'){
            return;
        }
        if($(this).hasClass('active')){
            return;
        }
        $(this).parent().children('a').removeClass('active');
        $(this).addClass('active');
        var options=JSON.parse($('.buy').attr('data-options'));
        var items='';
        for(var j=0;j<$('.options li').length;j++){
            if($($('.options li')[j]).find('a.active')) {
                items += '+' + $($('.options li')[j]).find('a.active').html();
            }
        }
        for(var i=0;i<options.length;i++){
            if(items.slice(1)==options[i].title){
                $('.oprice').val(options[i].costprice);
                $('.weight').val(options[i].weight);
                $('.hasoption').attr('data-optionname',options[i].title);
            }
        }
    });

    //运费模板选择
   function courier(self){
        if($('.weight').val()==''){
            util.tips('请先选择规格');
            return;
        }
        if($('[name="province"] option:selected').val()==''||$('[name="city"] option:selected').val()==''||$('[name="county"] option:selected').val()==''){
            util.tips('请先选择地区');
            return;
        }
        if($(self).hasClass('active')){
            return;
        }
        var weight=Number($('.weight').val())*Number($('.num').val());
        $.get(
            "{php echo web_url('platform/goods_list/freight')}",
            {
                'tid':$(self).attr('data-id'),
                'province':$('[name="province"] option:selected').html(),
                'city':$('[name="city"] option:selected').html(),
                'county':$('[name="county"] option:selected').html(),
                'weight':weight
            },
            function(res){
                var data=JSON.parse(res);
                if(data.freight){
                    $('.courier_num').val(data.freight);
                }else{

                }
            }
        );
        $(self).parent().children('a').removeClass('active');
        $(self).addClass('active');
    };

    //地址选择引入
//     var urlB='{TG_URL_WRES}lib/bootstrap-chinese-region/sql_areas.json';
//     $.getJSON(urlB,function(data){
//         for (var i = 0; i < data.length; i++) {
//             var area = {id:data[i].id,name:data[i].cname,level:data[i].level,parentId:data[i].upid};
//             data[i] = area;
//         }
// //        setTimeout(function(){
//             $('.bs-chinese-region').chineseRegion('source',data);
// //        },2000)

//     });

    //立即购买按钮
    function buy(self) {
        if($(self).attr('data-option')==1){
            var liLen=$('.options li').length;
            var aLen=$('.options a.active').length;
            if(liLen!=aLen){
                util.tips('请选择规格');
                return;
            }
        }
        if($('input.tel').val()==''){
            util.tips('请收入手机号');
            return;
        }
        if(!(/^1[34578]\d{9}$/.test($('input.tel').val()))){
            util.tips('手机号填写有误');
            return;
        }
        if($('.num').val()==''){
            util.tips('请填写数量');
            return;
        }
        if($('#address').val()==''){
            util.tips('请选择地址');
            return;
        }
        if($('.paydetail .addDetail').val()==''){
            util.tips('请填写详细地址');
            return;
        }
        if(!$('.courier a').hasClass('active')){
            util.tips('请选择快递');
            return;
        }
        if(Number($('.num').val())<Number($(self).attr('data-minnum'))){
            util.tips('购买量必须大于'+$(self).attr("data-minnum")+'件');
            return;
        }
        $.post(
            "{php echo web_url('platform/goods_list/shop_submit')}",
            {
                'id':$(self).attr('data-id'),
                'tid':$('.courier .active').attr('data-id'),
                'weight':$('.weight').val(),
                'freight':$('.courier_num').val(),
                'optionname':$('.hasoption').attr('data-optionname'),
                'gnum':$('input.num').val(),
                'addname':$('input.name').val(),
                'mobile':$('input.tel').val(),
                'province':$('[name="province"] option:selected').html(),
                'city':$('[name="city"] option:selected').html(),
                'county':$('[name="county"] option:selected').html(),
                'address':$('.addDetail').val()
            },
            function(res){
                var data=JSON.parse(res);
                console.log(data);
                if(data.status != '1') {
                    util.tips(data.message);
                    return;
                }
                if(data.copy==1){
                    $.post("{php echo web_url('goods/goods/copy',array('copy'=>1));}", {id: $(self).attr('data-id')}, function (data) {
                    }, 'json');
                }
                if(data.order_id>0){
                    var orderid=data.order_id;
                    $.post("{php echo web_url('platform/platform_pay/pay');}", {'money': data.money,'orderid':orderid}, function (res) {
                        var data = JSON.parse(res);
                        console.log(data);
                        if (data.status == 'success') {
                            $("#payimage").attr('src', urlC + data.data.url);
                            $('.wx').css('display','block');
                            timeJS(data.data.order_id,orderid);
                        }
                    });

                }
            }
        )
    }
    



    function ajaxCity() {
        var id= $('select[name="province"] option:selected').val();
        $.get(
            "{php echo web_url('store/bdelete/county')}",
            {
                "opp":'city',
                "sid":id
            },
            function (res) {
                var data=JSON.parse(res).data;
                console.log(data);
                var html='<option value="">市</option>';
                for(var key in data){
                    html += "<option value='" + data[key].id + "'>" + data[key].areaname + "</option>";
                }
                $('select[name="city"]').html(html);
                $('select[name="county"]').html('<option value="">区</option>');
            }
        )
    }
    function ajaxCounty() {
        var id= $('select[name="city"] option:selected').val();
        $.get(
            "{php echo web_url('store/bdelete/county')}",
            {
                "opp":'county',
                "cid":id
            },
            function (res) {
                var data=JSON.parse(res).data;
                console.log(data);
                var html='<option value="">区</option>';
                for(var key in data){
                    html += "<option value='" + data[key].id + "'>" + data[key].areaname + "</option>";
                }
                $('select[name="county"]').html(html);
            }
        )
    }



    function buy(self) {
        if($(self).attr('data-option')==1){
            var liLen=$('.options li').length;
            var aLen=$('.options a.active').length;
            if(liLen!=aLen){
                util.tips('请选择规格');
                return;
            }
        }
        if($('input.tel').val()==''){
            util.tips('请收入手机号');
            return;
        }
        if(!(/^1[34578]\d{9}$/.test($('input.tel').val()))){
            util.tips('手机号填写有误');
            return;
        }
        if($('.num').val()==''){
            util.tips('请填写数量');
            return;
        }
        if($('#address').val()==''){
            util.tips('请选择地址');
            return;
        }
        if($('.paydetail .addDetail').val()==''){
            util.tips('请填写详细地址');
            return;
        }
        if(!$('.courier a').hasClass('active')){
            util.tips('请选择快递');
            return;
        }
        if(Number($('.num').val())<Number($(self).attr('data-minnum'))){
            util.tips('购买量必须大于'+$(self).attr("data-minnum")+'件');
            return;
        }
        $.post(
            "{php echo web_url('platform/goods_list/shop_submit')}",
            {
                'id':$(self).attr('data-id'),
                'tid':$('.courier .active').attr('data-id'),
                'weight':$('.weight').val(),
                'freight':$('.courier_num').val(),
                'optionname':$('.hasoption').attr('data-optionname'),
                'gnum':$('input.num').val(),
                'addname':$('input.name').val(),
                'mobile':$('input.tel').val(),
                'province':$('[name="province"] option:selected').html(),
                'city':$('[name="city"] option:selected').html(),
                'county':$('[name="county"] option:selected').html(),
                'address':$('.addDetail').val()
            },
            function(res){
                var data=JSON.parse(res);
                console.log(data);
                if(data.status != '1') {
                    util.tips(data.message);
                    return;
                }
                if(data.copy==1){
                    $.post("{php echo web_url('goods/goods/copy',array('copy'=>1));}", {id: $(self).attr('data-id')}, function (data) {
                    }, 'json');
                }
                if(data.order_id>0){
                    var orderid=data.order_id;
                    $.post("{php echo web_url('platform/platform_pay/pay');}", {'money': data.money,'orderid':orderid}, function (res) {
                        var data = JSON.parse(res);
                        console.log(data);
                        if (data.status == 'success') {
                            $("#payimage").attr('src', urlC + data.data.url);
                            $('.wx').css('display','block');
                            timeJS(data.data.order_id,orderid);
                        }
                    });

                }
            }
        )
    }

    function clearTimeJS(){
        window.clearInterval(myIntval);
        $('#payimage').attr('src','');
    }
</script>     
{php include wl_template('common/footer');}