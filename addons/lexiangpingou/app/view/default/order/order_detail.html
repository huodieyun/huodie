{php include wl_template('common/header');}
<script type="text/javascript" src="{TG_URL_ARES}js/qrcode.js"></script>
<style>
	.timline-block-arrow{
		border-top: 1px solid transparent;
		border-left: 1px solid transparent;
	}
	.timeline-block{
		border:1px solid transparent!important;
	}
</style>
<div class="page-group">
    <div class="page page-current" id="page-order-detail">
	    <header class="bar bar-nav">
	    	<a style="color:#f99b00" class="button button-link button-nav pull-left back" href="{php echo app_url('order/order/list')}"><span class="icon icon-left"></span>返回</a>
	    	<h1 class="title">订单详情</h1>
	  	</header>
    	
		<div class="content" style="overflow-x: hidden;">
			<div id="nav" class="nav">
			    <p class="nav-wrap">
			        <span class="j-nav-item j-nav-status nav-item nav-choose">订单状态</span>
			        <span class="j-nav-item j-nav-detail nav-item ">订单详情</span>
			        <label class="j-nav-bottomline nav-bottomline"></label>
			    </p>
			</div>
			<div id="order-status">
			    <div class="timeline">
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p1.meituan.net/xianfu/8adf62cf3cb75f1a4b21380be10af9fa2048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已提交<span class="timeline-time">{php echo date('m-d H:i', $order['createtime']);}</span></p>
		                    <p class="timeline-sub">等待用户支付订单</p>
		                </div>
		            </div>
		            {if $order['ptime']}
		            <div class="timeline-connect timeline-connect-21"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/794ec85889844239f32764861c56660a2048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">支付成功<span class="timeline-time">{php echo date('m-d H:i', $order['ptime']);}</span></p>
		                    <p class="timeline-sub"></p>
		                </div>
		            </div>
		            {/if}
					{if $order['godluck']==1}
					<div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已中奖<span class="timeline-time"></span></p>
		                    <p class="timeline-sub">我们将尽快为您发货</p>
		                </div>
		            </div>
					{/if}
					{if $order['godluck']==0&&$order['selltype']==5&&$order['issued']==0}
					<div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单未开奖,请耐心等待哦<span class="timeline-time"></span></p>
		                    
		                </div>
		            </div>
					{/if}
					{if $order['godluck']==0&&$order['selltype']==5&&$order['issued']==1}
					<div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单未中奖<span class="timeline-time"></span></p>
		                    {if $order['status']==8}<p class="timeline-sub">我们将尽快为您退款</p>{/if}
							{if $order['status']==7}<p class="timeline-sub">订单已退款,优惠券已发放</p>{/if}
							 {if $order['status']==10}<p class="timeline-sub">我们正在尽快为您退款</p>{/if}
		                </div>
		            </div>
					{/if}
                    {if $order['delivery_time'] != 0}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/a34001a981214d535bd8466da34490502048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">商家发货<span class="timeline-time">{php echo date('m-d H:i', $order['delivery_time']);}</span></p>
		                    <p class="timeline-sub">商品已发货，请耐心等待哦</p>
		                </div>
		            </div>
		            {/if}
		            {if $order['gettime']}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已完成<span class="timeline-time">{php echo date('m-d H:i', $order['gettime']);}</span></p>
		                    <p class="timeline-sub">感谢您的信任，祝您生活愉快</p>
		                </div>
		            </div>
		            
		            {/if}
		            {if $notshow != 1}

		           <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-message timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <a href="{php echo app_url('order/order',array('op' => 'judgment_detail','id' => $order['id']))}"><div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title" style="color: #f99b00;text-align: left;">开始评价</p>
							<p class="timeline-sub">点击输入您要评价的内容</p>

		                </div>
		                </a>
		            </div>
		            {/if} 
					{if $order['status']==4||$order['status']==6||$order['status']==7}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已退款{if $order['issued']==2},优惠券已发放{/if}<span class="timeline-time"></span></p>
							<p class="timeline-sub">退款原因：{$order['refund_res']}</p>
		                    <p class="timeline-sub">{if $order['issued']==2}很遗憾未中奖,{/if}感谢您的信任,祝您生活愉快</p>
		                </div>
		            </div>
		            {/if}
					
			    </div>
			    
			    <div class="bottombar-placeholder"></div>
			
			    <div class="bottombar-down">
			        <div class="bottombar">
			    		
			        	<div class="bottombar-main" style="margin-left:15px;">
						    <div class="bottombar-buttonwrap bottombar-buttonwrap-3" >
                                {if $order['status'] == 2 && $order['dispatchtype'] == 1 && $order['storeid']}
                                <button class="combtn bottombar-btn-red open-popup" id="qrcode" data-popup=".popup-qrcode"style="width:90px;text-align:center;"><i class="fa fa-qrcode" ></i>&nbsp确认收货</button>
                                {elseif $order['status'] == 2}
						        <button id="btn-received" class="combtn bottombar-btn-red" oid="{$order['id']}">确认收货</button>
						        <button id="btn-hasten" class="combtn bottombar-btn-dark">物流信息</button>
						        {elseif ($order['status'] == 8 || $order['status'] == 2) && $order['dispatchtype']==3 && !($order['selltype'] == 5&& $order['issued']== 0)}

                                <button class="combtn bottombar-btn-red open-popup" id="qrcode" data-popup=".popup-qrcode"style="width:85px;text-align:center;"><i class="fa fa-qrcode" ></i>&nbsp到店核销</button>
                                {elseif $order['dispatchtype'] == 3 && $order['status'] == 3 && $kaiguan['hexiaotuikuan'] == 1}
                                <button class="combtn bottombar-btn-red open-popup" id="reqrcode" data-popup=".popup-qrcode"style="width:85px;text-align:center;"><i class="fa fa-qrcode" ></i>&nbsp到店退货</button>
                                {else}
                                <button class="combtn bottombar-btn-red" style="width: 23%;" onclick="location.href='{php echo app_url('goods/list');}'">更多商品</button>
                                {/if}
                                {if $order['is_tuan']==1 && $order['status']!=5}
                                <button class="combtn bottombar-btn-dark" onclick="location.href='{php echo app_url('order/group', array('tuan_id'=>$order['tuan_id']));}'" style="width:85px;">查看团详情</button>
                                {/if}
								{if $order['godluck']==0 && $order['status']==7}
		                        <button class="combtn bottombar-btn-dark" onclick="location.href='{php echo app_url('member/coupon');}'" style="width:82px;">查看优惠券</button>
		                        {/if}
								{if $_W['uniacid']=='33'||$_W['uniacid']=='2008'}
								<button class="combtn bottombar-btn-dark" style="width:82px; margin-top: 5px;" onclick="location.href='{if $url_kefu!=''}{$url_kefu}{else}javascript:;{/if}'">客服</button>
								{/if}
		                        {if ($sto["lag"] !="default" || $sto["lng"] != "default") && $order['dispatchtype'] == 3}
					            <div class="combtn bottombar-btn-red" style="margin-top:5px;display: inline-block; margin-right: 10px;width: 90px;height:30px;line-height:30px;text-align: center;border-radius: 2px">
					            	<i class="iconal-location"></i>
					            	<label id="openLocation">门店导航</label>
					            </div>
					            {/if}
					            {if $order['is_once_card'] == 1 && $order['status'] == 8}
					            	<!-- 次卡并是待发货 -->
					            	<a href="{php echo app_url('order/order_once_card/order_detail', array('id' => $order['id']))}"><button class="combtn bottombar-btn-dark" style="width:82px;">发货记录</button></a>
					            	<a href="{php echo app_url('order/order_once_card/order_edit', array('id' => $order['id']))}"><button class="combtn bottombar-btn-dark" style="width:82px;margin-top: 5px;">修改信息</button></a>
					            {/if}
						    </div>
			            </div>
			        </div>
			    </div>
			</div>
			
			<div id="order-detail" style="display: none">
			    <div class="orderregion">
			        <a class="status-hotelname" href="#">
			            <i class="icon1-detail status-hotelname-icon"></i>
			            <label class="status-hotelname-name">{$order['merchant_name']}</label>
			            <i class="icon-arrow-right-thin status-hotelname-back"></i>
			        </a>
			    </div>
			    
			    <div class="orderregion orderregion-top">
			        <ul class="orderregion-entries">
					{if $order['g_id']>0}
			            <li class="orderregion-entry">
			                <span class="name text-overflow-ellipsis-2">{$order['goodsname']}</span>
			               <!-- <span class="price">￥{php echo $goods['gprice']*$order['gnum']}</span>-->
			                <span class="price" >{if $order['is_tuan']==0}{$goods['oprice']}{elseif $order['is_tuan']==1}{$goods['gprice']}{/if}×{$order['gnum']}</span>
			            </li>
						{else}
						<?php 
								$col=pdo_fetchall("select * from ".tablename('tg_collect')." where  orderno=:orderno",array('orderno'=>$order['orderno']));
								?>
								 {loop $col $v}
								 <?php 
								$gs=pdo_fetch("select * from ".tablename('tg_goods')." where  id=:id",array('id'=>$v['sid']));
								
								?>
								<li class="orderregion-entry">
			                <span class="name text-overflow-ellipsis-2">{$v['goodsname']}</span>
							 <span class="name text-overflow-ellipsis-2">规格：{$v['item']}</span>
			               <!-- <span class="price">￥{php echo $goods['gprice']*$order['gnum']}</span>-->
			                <span class="price" >{$v['oprice']}×{$v['num']}</span>
			            </li>
						
								 {/loop}
						{/if}
			        </ul>
			    </div>
			<?php 
								$refund=pdo_fetch("select * from ".tablename('tg_order_level_refund')." where  orderno=:orderno",array('orderno'=>$order['orderno']));
							$realprice=	round($order['pay_price'],2)-round($refund['refundprice'],2);
								?>
			    <div class="orderregion">
			        <ul class="orderregion-entries">
					{if $gs['selltype']==4}
					 <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">返还</span>
			                <span class="price">￥&nbsp;{$refund['refundprice']}</span>
			            </li>
						{/if}
			            <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">运费</span>
			                <span class="price">￥&nbsp;{$order['freight']}</span>
			            </li>
			            <li class="orderregion-entry order-total-price">
			                <span class="name text-overflow-ellipsis-2">合计</span>
			                <span class="price">￥&nbsp;{$realprice}</span>
			            </li>
			        </ul>
			    </div>

			    <!--门店-->
	            {if $order['dispatchtype'] == 3}
	            <div class="orderregion">
			        <h1 class="orderregion-title" style="display: flex;flex-direction: row;justify-content: space-between;align-items: center;">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">核销信息</label>
			      
			        </h1>
			        <ul class="orderregion-entries-compact">
					 <li class="orderregion-entry-compact">
			                <span class="label">收货人：</span>{$order['addname']}&nbsp; {$order['mobile']}
			            </li>
					 
					 <li class="orderregion-entry-compact">
			                <span class="label">提货点：</span>{$sto['storename']}
			            </li>
			           <li class="orderregion-entry-compact">
			                <span class="label">核销员：</span>{$sal['nickname']}
			            </li>
			            <li class="orderregion-entry-compact" id="hexiaotime">
			                <span class="label">核销时间：</span>{php echo date('Y-m-d H:i:s', $order['hexiaotime']);}
			            </li>
			        </ul>
			    </div>
				<!--<div class="good_speci" onclick="showStores(this)" show="1">适用的商家信息<i class="fa fa-angle-down" style="float:right; line-height:44px; font-size:26px;"></i></div>
	  			<div>
		  			{loop $stores $stores}
			        <div class="store">
			            <div class="info">
			            <div class="ico"><i class="fa fa-university"></i></div>
			            <div class="info1">
			                <div class="inner">
			                     <div class="user">{$stores['storename']}</div>
			                     <div class="addresss">地址: {$stores['address']}</div>
			                     <div class="tel">电话: {$stores['tel']}</div>
			                 </div>
			             </div>
			             <a href="http://api.map.baidu.com/marker?location={$stores['lat']},{$stores['lng']}&amp;title={$stores['storename']}&amp;name={$stores['storename']}&amp;content={$stores['address']}&amp;output=html" class="external"><div class="ico2"><i class="fa fa-map-marker"></i></div></a>
			             <a href="tel:{$stores['tel']}" class="disable-router"><div class="ico3"><i class="fa fa-phone"></i></div></a>
			        	</div>
			        </div>
					{/loop}
		       	</div>-->
		       	{else}
		       	<div class="orderregion">
			        <h1 class="orderregion-title">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">配送信息</label>
			        </h1>
			        <ul class="orderregion-entries-compact">
			            <li class="orderregion-entry-compact">
			                <span class="label">收货人：</span>{$order['addname']}&nbsp; {$order['mobile']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">收货地址：</span>{$order['address']}
			            </li>
			        </ul>
			    </div>
		       	{/if}
		       	
			    <div class="orderregion">
			        <h1 class="orderregion-title">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">订单详情</label>
			        </h1>
			        <ul class="orderregion-entries-compact">
			            <li class="orderregion-entry-compact">
			                <span class="label">订单号码：</span>{$order['orderno']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">下单时间：</span>{php echo date('Y-m-d H:i:s', $order['createtime']);}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">支付方式：</span>{if $order['pay_type'] == 9}会员余额{else}微信{/if}支付
			            </li>
			            {if $order['remark']}
			            <li class="orderregion-entry-compact">
			                <span class="label">备注：</span>{$order['remark']}
			            </li>
			            {/if}
			        </ul>
			    </div>

			    <div class="buy-again-placeholder"></div>
			    </div>
			</div>
		</div>
	</div>
</div>
<div class="popup popup-qrcode">
  	<div class="content" style="background: #eee;">
    	<div class="list-block cards-list">
	      <ul>
	        <li class="card" style="border-radius: .2rem;">
	          <div class="card-header"><h3 class="font-size-14">{if $order['dispatchtype'] == 3 && $order['status'] == 8}到店自提{elseif $order['dispatchtype'] == 3 && $order['status'] == 3}到店退货{elseif $order['dispatchtype'] == 1}送货上门{/if}核销凭证</h3></div>
	          <div class="card-content" style="border-top: 1px solid #e5e5e5">
				<div id="nav" class="nav">
				    <p class="nav-wrap">
				        <span class="j-nav-item j-nav-qrcode nav-item nav-choose" {if $order['dispatchtype'] == 1 || $order['status'] == 3}style="width:100%;"{/if}>手机微信核销码 </span>
                        {if $order['dispatchtype'] == 3 && $order['status'] == 8}
                        <span class="j-nav-item j-nav-pcqrcode nav-item " >收银台扫描枪核销码</span>
				        <label class="j-nav-code-bottomline nav-bottomline"></label>
                        {/if}
				    </p>
				</div>
	            <div class="card-content-inner">
			         <p style="text-align: center; font-size: 1.1em; ">请将本二维码出示给{if $order['dispatchtype'] == 3}核销员{elseif $order['dispatchtype'] == 1}派送员{/if}</p>
					<p id="qrcode_pic" style="text-align: center">
						<!--<img style=" width: 100%;" src="{php echo app_url('order/order/qr' , array('url' => $order['short_url']))}" id="qrsrc" alt="">-->

					</p>


					<p id="pcqrcode_pic" style="display: none;text-align: center">

						<!--<img style=" width: 100%;" src="{php echo app_url('order/order/qr' , array('url' => $order['orderno']))}" alt="">-->
					</p>
			        <div class="voucher-address font-size-14">
                        {if $order['dispatchtype'] == 1}
                        <p>派送员昵称：{$sto['nickname']}</p>
                        <!--<p>提货地址：{$sto['address']}</p>-->
                        <!--&lt;!&ndash;<p>到店时间：尽快到店提货</p>&ndash;&gt;-->
                        <p>联系电话：{$sto['tel']}</p>
                        {else}
                        <p>提货点：{$sto['storename']}</p>
			            <p>提货地址：{$sto['address']}</p>
			            <!--<p>到店时间：尽快到店提货</p>-->
					    <p>联系电话：{$sto['tel']}</p>
                        {/if}
			<!--  <li style="width:94%;padding:5px;border:1px dashed red;margin:8px auto;border-radius:5px;overflow:hidden;"><p style="font-size:0.7rem;color:#DE5246;text-indent:1rem;">{$config['content_set']}<p></li>
-->
		</div>
					{if $order['g_id']>0}
			        <div class="voucher-goods-info font-size-14">
			            <p>商品名称：{$goods['gname']} </p>
						{if !empty($order['optionname'])}<p>商品规格：{$order['optionname']} </p>{/if}
						<p>数量：{$order['gnum']}</p>
				        <p>实付金额：{$order['price']}元</p>
				        </div>
				    
					{else}
					
				   <?php 
								$col=pdo_fetchall("select * from ".tablename('tg_collect')." where  orderno=:orderno",array('orderno'=>$order['orderno']));
								?>
								 {loop $col $v}
								 <?php 
								$gs=pdo_fetch("select * from ".tablename('tg_goods')." where  id=:id",array('id'=>$v['sid']));
								?>
									
									 <div class="voucher-goods-info font-size-14">							
										<p>{$gs['gname']}</p>
										<p>{if !empty($v['item'])}规格：{$v['item']},{/if}</p>
										<p>数量:{$v['num']},单价:{$v['oprice']}</p>
										
										<hr style="margin-top: 10px;margin-bottom: 0px;"/>
									</div>
									
								 {/loop}
					{/if}
					 </div>
	          </div>
	        </li>
	      </ul>
	    </div>
	    <div class="weui_btn_area">
        	<a class="weui_btn weui_btn_warn close-popup">关闭</a>
    	</div>
  	</div>
</div>
<script>
{if $order['status']==3}
//$('#qrcode_pic').hide();
$('#pcqrcode_pic').hide();
{/if}
{if ($order['godluck']==1&&$order['selltype']==5)||$order['selltype']!=5}
window.onload = function () {
	var url = location.href;
	var popupQrcode = document.getElementsByClassName("popup popup-qrcode")[0];
	if (url.indexOf("b=1") > 0) {
	  popupQrcode.classList.add("modal-in");
	  popupQrcode.style.display = 'block';
	}
}
{/if}
if (document.getElementById("hexiaotime")){
	var hexiaotime=document.getElementById("hexiaotime").innerHTML.slice(52,71);
	//alert(hexiaotime == "1970-01-01 08:00:00");
	if (hexiaotime == "1970-01-01 08:00:00"){
		document.getElementById("hexiaotime").innerHTML = '<span class="label">核销时间：未核销</span>';
	}
	}
	$(document).on('click','#btn-received',function(){
		var orderno = $(this).attr('oid');
		$.confirm('是否确认收货？',
	        function () {
	          	$.post("{php echo app_url('order/order/receipt')}",{orderno:orderno},function(d){
					if(d.status == 1){
					    $.toast('确认收货成功！');
					    setTimeout(function () {
							location.href = "{php echo app_url('order/order/detail')}"+'id='+orderno;
						}, 1000);
					}else{
						$.toast(d.result);
					}
				},"json");
	        }
	    );
	});
	
	$(document).on('click','#btn-hasten',function(){
	    $.showIndicator();
	    setTimeout(function () {
			location.href = "http://m.kuaidi100.com/index_all.html?type={$order['express']}&postid={$order['expresssn']}#input";
		}, 1000);
	});
	
	$(".j-nav-status").bind('click', function() {
		$('.j-nav-status').addClass('nav-choose');
		$('.j-nav-detail').removeClass('nav-choose');
		$('.j-nav-bottomline').removeClass('nav-bottomlineright').addClass('nav-bottomline');
		$('#order-status').show();
		$('#order-detail').hide();
	});
	$(".j-nav-detail").bind('click', function() {
		$('.j-nav-detail').addClass('nav-choose');
		$('.j-nav-status').removeClass('nav-choose');
		$('.j-nav-bottomline').removeClass('nav-bottomline').addClass('nav-bottomlineright');
		$('#order-status').hide();
		$('#order-detail').show();
	});
	
	$(".j-nav-qrcode").bind('click', function() {
		$('.j-nav-qrcode').addClass('nav-choose');
		$('.j-nav-pcqrcode').removeClass('nav-choose');
		$('.j-nav-code-bottomline').removeClass('nav-bottomlineright').addClass('nav-bottomline');
		$('#qrcode_pic').show();
		$('#pcqrcode_pic').hide();
	});
	$(".j-nav-pcqrcode").bind('click', function() {
		$('.j-nav-pcqrcode').addClass('nav-choose');
		$('.j-nav-qrcode').removeClass('nav-choose');
		$('.j-nav-code-bottomline').removeClass('nav-bottomline').addClass('nav-bottomlineright');
		$('#qrcode_pic').hide();
		$('#pcqrcode_pic').show();
	});
	var lat = '{$sto["lat"]}' === 'default'? '' : '{$sto["lat"]}';
	var lng = '{$sto["lng"]}' === 'default'? '' : '{$sto["lng"]}';      
	if(lat != '' && lng != ''){ 
		lat = Number(lat); 
		lng = Number(lng);  
		document.querySelector('#openLocation').onclick = function () {
	    wx.openLocation({
	      latitude: lat,
	      longitude: lng,  
	      name: "{$sto['storename']}",
	      address:'{$sto["address"]}',
	      scale: 14,
	      infoUrl: "{php echo app_url('goods/list')}"
	    });
	  };
	}
//转二维码
$('canvas').remove();
var longurl="{php echo $order['longurl']}";
var orderurl="{php echo $order['orderno']}";
$('#qrcode_pic').qrcode({text:longurl});
$('#pcqrcode_pic').qrcode({text:orderurl});
</script>
{php include wl_template('common/footer');}